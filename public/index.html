 <!DOCTYPE html>
<meta charset="utf-8">
<title>主页</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <img id="avatar" width="50" height="50" class="rounded-circle">
      <span id="username" class="ms-2"></span>
    </div>
    <button class="btn btn-outline-danger" onclick="logout()">退出</button>
  </div>

  <div class="card mb-3 p-3">
    <input type="file" id="avatarInput" class="form-control mb-2">
    <button class="btn btn-sm btn-primary" onclick="uploadAvatar()">更换头像</button>
  </div>

  <div class="card p-3 mb-3">
    <input class="form-control mb-2" id="title" placeholder="标题">
    <textarea class="form-control mb-2" id="content" rows="2" placeholder="内容"></textarea>
    <button class="btn btn-primary" onclick="save()">保存</button>
    <button class="btn btn-secondary ms-2" onclick="reset()">取消</button>
  </div>

  <div class="d-flex gap-2 mb-3">
    <input class="form-control" id="kw" placeholder="搜索">
    <button class="btn btn-outline-primary" onclick="load()">搜索</button>
    <button class="btn btn-success" onclick="exportExcel()">导出Excel</button>
  </div>

  <div id="list" class="mb-3"></div>
  <div id="pages" class="d-flex gap-2 justify-content-center"></div>
</div>

<script>
let page = 1, size = 10, editId = null
const user = await fetch('/api/user/info').then(r=>r.json()).then(j=>j.data)
if(!user) location.href='/login'
document.getElementById('username').innerText = user.username
document.getElementById('avatar').src = user.avatar

async function load(){
  const r=await fetch(`/api/data/list?page=${page}&size=${size}&keyword=${document.getElementById('kw').value}`)
  const j=await r.json()
  const list = j.data.list
  document.getElementById('list').innerHTML = list.map(i=>`
    <div class="card p-3 mb-2">
      <h5>${i.title}</h5>
      <p>${i.content||''}</p>
      <button class="btn btn-sm btn-warning me-1" onclick="edit(${i.id},'${i.title}','${i.content}')">编辑</button>
      <button class="btn btn-sm btn-danger" onclick="del(${i.id})">删除</button>
    </div>
  `).join('')
}

async function save(){
  const title = document.getElementById('title').value
  const content = document.getElementById('content').value
  const url = editId ? '/api/data/update' : '/api/data/add'
  await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify(editId?{id:editId,title,content}:{title,content})})
  reset()
  load()
}

function edit(id,t,c){ editId=id; document.getElementById('title').value=t; document.getElementById('content').value=c }
function reset(){ editId=null; document.getElementById('title').value=''; document.getElementById('content').value='' }
async function del(id){ await fetch('/api/data/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})}); load() }
function logout(){ fetch('/api/logout').then(()=>location.href='/login') }
async function uploadAvatar(){
  const f = new FormData()
  f.append('avatar',document.getElementById('avatarInput').files[0])
  const r=await fetch('/api/user/avatar',{method:'POST',body:f})
  const j=await r.json()
  document.getElementById('avatar').src = j.data
}
function exportExcel(){ window.open('/api/data/export') }
load()
</script>